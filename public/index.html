<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Trello Tasks</title>
</head>

<body>
    <h1>Trello tasks</h1>
    <div id="inputContainer">
        <label for="boardUrl">Enter Trello Board URL:</label>
        <input type="text" id="boardUrl" placeholder="https://trello.com/b/boardId">
        <button id="submitUrl">Submit</button>
    </div>

    <div id="taskContainer" style="display:none;">
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Due Date</th>
                </tr>
            </thead>
            <tbody id="taskTableBody"></tbody>
        </table>
        <button id="refreshButton">Refresh Tasks</button>
        <button id="changeBoardButton">Change Board</button>
    </div>

    <script>
        const inputContainer = document.getElementById("inputContainer");
        const taskContainer = document.getElementById("taskContainer");
        const boardUrlInput = document.getElementById("boardUrl");
        const submitUrlButton = document.getElementById("submitUrl");
        const taskTableBody = document.getElementById("taskTableBody");
        const refreshButton = document.getElementById("refreshButton");
        const changeBoardButton = document.getElementById("changeBoardButton");

        // Define the base URL for the API
        const apiBaseUrl = "http://localhost:3000/trello";
        let boardId = null;

        // Function to show or hide elements based on user interaction
        function toggleContainers() {
            inputContainer.style.display = "none";
            taskContainer.style.display = "block";
        }

        // Function to fetch and display tasks
        async function fetchAndDisplayTasks() {
            try {
                const response = await fetch(`${apiBaseUrl}/${boardId}/tasks`, {
                    method: 'GET',
                    credentials: 'include', // Include credentials in the request
                });

                const tasks = await response.json();

                console.log("Received JSON response:", tasks);

                if (tasks.success && tasks.data.length > 0) {
                    // Clear the table body
                    taskTableBody.innerHTML = "";

                    // Iterate through tasks and add rows to the table
                    tasks.data.forEach(task => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${task.name}</td>
                            <td>${task.desc || 'N/A'}</td>
                            <td>${task.due || 'N/A'}</td>
                        `;
                        taskTableBody.appendChild(row);
                    });
                } else {
                    taskTableBody.innerHTML = "<tr><td colspan='3'>No tasks found.</td></tr>";
                }
            } catch (error) {
                console.error("Error fetching tasks:", error);
                taskTableBody.innerHTML = `<tr><td colspan='3'>Error fetching tasks: ${error.message}</td></tr>`;
            }
        }

        // Add a click event listener to the Submit button
        submitUrlButton.addEventListener("click", async () => {
            const url = boardUrlInput.value.trim();
            if (url) {
                // Extract the boardId from the URL (you may need to adjust the extraction logic)
                let parts = url.split('/');
                boardId = parts[parts.length - 2]; // Updated boardId extraction
                console.log(boardId)

                toggleContainers();
                await fetchAndDisplayTasks();
            }
        });

        // Add click event listeners to the Refresh Tasks and Change Board buttons
        refreshButton.addEventListener("click", fetchAndDisplayTasks);
        changeBoardButton.addEventListener("click", () => {
            // Show the input container and hide the task container
            inputContainer.style.display = "block";
            taskContainer.style.display = "none";
            // Clear the boardId
            boardId = null;
        });
    </script>
</body>

</html>
